# Case-study оптимизации

### Шаг №1
Решил оптимизировать specs одного из проектов, над которым работаю.
Данный проект небольшой и имеет всего 142 examples

После настройки InfluxDB и метрики - я запустил тесты.
Метрика показала результат в 14 секунд

Первым делом я сходил и посмотрел на наличие гема database_cleaner и убрал его

Метрика показала следующее
![m_1](https://i.ibb.co/w6VQCW0/m-1.jpg)

То есть прирост всего в 1 секунду

### Шаг №2

Следующим шагом была установка и настройка parallel_tests
Результат был таков
![m_2](https://i.ibb.co/GtMfDG2/m-2.jpg)

Было сделано два запуска. При первом, время выполнения 12 секунд. На втором 11 секунд

### Шаг №3
При запуске профилировщиков не удалось увидеть точки роста, относящиеся к непосредственно тестам.
В первых рядах были различные библиотеки rails и сам rspec. Можно было исходя из этих результатов понять, в чем проблема.

Но решил также запустить `bin/rspec --profile`, что показало главной точкой росто спеки на контроллеры и requests.

В данных спеках, как такова логика отсутствовала. В них формировался params и отдавался запрос - то есть надо оптимизировать сам код

Поэтому решил попробовать пойти дальше, и заюзал
```
RD_PROF bin/rspec
```

Показало следующую картину
![m_3](https://i.ibb.co/tJrXz85/m-3.jpg)

Самое проблемное место, это spec/services/restaurant_finder_spec

Использовав let_it_be, удалось убрать spec/services/restaurant_finder_spec из главной точки роста

Дальше, я продолжил идти по списку и заменял на let_it_be и before_all где это было возможно.

К сожалению, не везде let_it_be применим. Есть спеки, где в каждом тесте `it .... do` нужны чистые данные тех или иных объектов/записей

![m_4](https://i.ibb.co/NLYVSZJ/m-4.jpg)

Как видно по Total time - он значительно уменьшился. До этого результат был 9.45, сейчас 3.1

Также, избавился от ненужных Rack::Test::UploadedFile

В итоге, при повторных запусках удалось добиться результата в 10 сек

![m_5](https://i.ibb.co/7RjMqQp/m-5.jpg)

### Шаг №4

Далее, к сожалению для домашнего задания, но к счастью для проекта, в таких инструментах, как create_default необходимости не было, так как в этом плане спеки были вполне оптимизированы. Также  build_stubbed не дал какого-то значительного прироста, да и мест было немного для него
К сожалению, на данный момент никак не удается преодолеть планку в 10 секунд выполнения всех тестов

По итогу, самые «жирные» спеки, это контроллеры/реквесты

![m_6](https://i.ibb.co/YP2pgLg/m-6.jpg)

## Результаты
Познакомился с инструментами для оптимизации тестов.
Parallel_tests - мощная штука, которая позволяет, практически ничего не делая, добиться значительного прироста в производительности

test-prof - очень нужные инструмент, который идет и как профилировщик, так и еще предоставляет хелперы для решения проблем.
Даже на этом проекте test-prof оказался очень полезным и с помощью него удалось добиться некоторой оптимизации.
Думаю, на проекте побольше и/или на тестах, которые имеют состояние похуже - он покажет себя во всей красе

Guard - к сожалению, до сегодняшнего дня я его не применял. А попробовав, не понимаю, как без него раньше жил =)
Очень удобное уведомление в верхней части панели, что позволяет не отвлекаться на постоянный запуск и проверку тестов
