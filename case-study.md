# Оптимизация тестов

### Кратко о компании и проекте

Кратко о компании: [Cashwagon](https://cashwagon.com), финансовый холдинг, выдаем потребительские и микрокредиты, имеем P2P площадки для инвестирования.

Кратко о проекте: внутренняя сис-ма, которая на текущий момент отвечает за:

- billing;
- pipeline от обработки заявки до выдачи денег (на банковский счет или карту);
- различные стратегии обработки заявки в зависимости от скоринга клиента;
- CRUD для работы с основными сущностями: заявки, продукты, договора, клиенты и т.д.;
- функционал для support manager'ов (1-й линии);
- много всего остального для внутренней работы, основные моменты выше.

### О проблеме

На текущий момент тесты длятся **10 минут**, суммарно тестов **~800**. О том как оптимизировать тесты читал и слушал давно, смотрел несколько докладов Вовы, читал другие статьи, первый раз трогал test-prof еще в версии 0.8 (или 0.9, точно не помню).

### Почему не оптимизировали?

1. Не доходили руки.
2. Это не является проблемой первого приоритета, т.к. есть более важные бизнесовые и технические вещи на текущий момент.

### Почему решил оптимизировать?

Потому что можно потратить время на домашнее задание с пользой.

### Feedback loop

1. Ищем точку роста.
2. Пытаемся оптимизировать.
3. Убеждаемся, что тест зеленый.
4. Повторяем, пока нас не устроит время.

### Первая точка роста: фабрики (очевидно)

Прогнал `RSpecDissect`, увидел, что время на создание фабрик ~7 минут (из ~10), стало понятно, что 70% времени занимает создание фабрик, в проекте не используются какие-то хелперы из `test-prof`, поэтом уже стало понятно куда копать. Получил топ-5 список, который занимает 4 минуты из 7, поменял `let` и `let!` на `let_it_be` насколько это возможно (в некоторых тестах это невозможно сделать из-за специфики реализации, придется их полностью переписывать, сформировали задачи в техдолг), так же поменял обычные `before(..)` на `before_all`.

Эти действия позволили срезать время с 4 минут до 1:30, в дальнейшем получится сделать еще быстрее, после рефактор определенных тестов.

Проделал это же действие еще раз, нашел еще фабрики, которые можно оптимизировать.

Суммарно удалось сэкономить время на создание фабрик до 2х минут, есть еще проблемы с каскадами, но сейчас уже проблема понятна, будет действовать в рабочем порядке.

**Profit 10 min → 5 min**

### Вторая точка роста: Sidekiq::Testing.inline!

По дефолту стоит `Sidekiq::Testing.fake!` , но в некоторых тестах в блоке `before` включен режим `inline`, нашел подобные тесты удалил подобные строчки, они все зеленые, для чего было включено - не понятно.

**Profit 5 min → 4 min**

### Третья точка кода: легаси тесты на легаси код

В процессе профилирования нашел тесты на код, который уже не используется, т.е. исторический код, который уже не участвует в бизнес процессах, пометил данные тесты тегом `unused`, уведомил команду и поменял запуск тестов на CI с исключением этого флага.

Удалять тесты и код пока что не хочется, потому что продакт сказал, что возможно в будущем мы захотим вернуть этот бизнес процесс.

**Profit 4 min → 3:30 min**

### Параллелизм

Добавил параллельный запуск в 2 потока, что позволило ускорить выполнение тестов в ~2 раза, это не актуально для CI, потому что там 1 ядро, но позволит быстрее прогонять тесты локально и уже запросили ресурсы у DevOps команды в виде еще 1 ядра для раннера.

**Profit 3:30 min → ~2 min**

### Итог

Удалось ускорить время выполнения тестов в ~5 раз, сгруппировал список основных ошибок и кейсов как не нужно писать тесты (в будущем хочется обсудить это внутри команды).