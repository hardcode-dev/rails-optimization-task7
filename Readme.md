# Выполнение

1) Скачал и запустил TICK-docker;
2) добавил конфиги и influxer, проверил, что Chronograf работает;
3) класс для отправки метрик и rake-task я скопипастил из лекции и начал гонять тесты в своем (тесты для service-objects).

4) Сначала посмотрел rspec-dissect-ом. Он написал самые долгие тесты.
5) Добавил test-prof и before_all хук, стало немного побыстрее.
6) Дальше я нашел у себя использование метода create_list, начал вместо него использовать activerecord-import.

Сделал такую оптимизацию для пары файлов. График для одного из них:

Все сервисы этого типа выполняются обычно 95-110 секунд (в данном проекте)
После оптимизации стало 78 секунд (исправил не везде еще)

7) запусти rspec --profile для всего suite
8) отчет показал самый медленный набор тестов (3 штуки), проходят 11 секунд
9) покопался там, оказалось, что опять create_list. НО! еще осложнило дело гора ассоциаций для объектов, которые создаются с помощью create_list
10) меняю метод создания с create_list на activerecord-import, при этом фабрику не использую, а создают ассоциации вручную по 1 штуки и присваиваю уже их
(это быстро, в отличие от фабрики, которая на каждый объект создает новую ассоциацию). В результате эти 3 теста выполняются 0,8 секунд

Интересно, но общая продолжительность уменьшилась на 2 секунды - стала 76 секунд.

Скрины смотреть в pull-request.


# Задание №7. Оптимизация `test-suite` и сбор `DX`-метрик

В этом задании вам нужо попрактиковаться в оптимизации `test-suite` и сборе `DX`-метрик.

## Оптимизация test-suite
Можно оптимизировать test-suite `dev.to`, либо своего проекта.

В любом случае для сдачи задания нужно написать `case-study` о сделанной оптимизации.

Вооружитесь инструментами, рассмотренными на лекции, и разгоните этот test-suite!

## Сбор DX-метрики

Чтобы запечатлеть свой прогресс и в дальнейшем защитить его от деградации, сделайте сбор `DX`-метрики времени выполнения `test-suite` в `InfluxDB` и постройте график в `Chronograf`.

Сделать это очень просто с помощью https://github.com/influxdata/TICK-docker и https://github.com/palkan/influxer.

Подумайте, как бы вам было удобно прикрепить отправку метрики в `InfluxDB` к прогону тестов.

## Hints

Старайтесь держать `feedback-loop` коротким. `test-suite` `dev.to` целиком в один процесс выполняется около 10 минут, это очень долго.

Используйте семплирование или работайте с конкретными наиболее долгими тестами.

Если вы обнаружите проблему, то выберите какой-нибудь один тест, на котором она воспроизводится, и исправьте её, работая с этим тестом.

Попробуйте все инструменты из `test-prof`!

`json-flamegraph` для всего `test-suite` целиком занимает около `1Gb`. `Speedscope.app` открыть его не может.

C отчётом `stackprof` для всего `test-suite` можно работать через `CLI stackprof`, и через `qcachegrind`.

С `ruby-prof` надо работать ещё аккуратнее, потому что он, как `tracing profiler`, собирает очень много данных, с которыми в дальнейшем тяжело работать.


## Чек-лист для сдачи задания
- [x] PR в этот репозиторий с `case-study` о проделанной оптимизации и достигнутых результатах в описании
- [x] Если оптимизируете `dev.to`, то сделать `PR` с оптимизацией в https://github.com/hardcode-dev/rails-optimization-2-task4 и добавить в этот PR ссылку на него
- [x] Добавить скриншот с графиком изменения времени прогона `test-suite` в `Chronograf` по мере оптимизации
